<script type="module">
  async function enhanceGlossaryTerms() {
    const res = await fetch('/glossary-terms.json');
    const glossary = await res.json();
    const postBody = document.querySelector('#post-body');
    if (!postBody) return;

    const terms = Object.keys(glossary);

    for (const term of terms) {
      const slug = glossary[term];
      const regex = new RegExp(`\\b(${term})\\b`, 'i');

      const paragraphs = postBody.querySelectorAll('p');
      for (const p of paragraphs) {
        if (regex.test(p.textContent)) {
          const html = p.innerHTML;
          const updated = html.replace(
            regex,
            `
<span tabindex="0" 
      class="glossary-term group cursor-help border-b border-dotted border-pink-500 inline-block relative"
      data-slug="${slug}">
  <a href="/glossary/${slug}" class="no-underline">
    <span class="glossary-tooltip hidden absolute z-50 bg-white dark:bg-gray-900 text-black dark:text-white border border-gray-300 dark:border-gray-600 shadow-lg p-2 w-64 max-w-sm"></span>
    $1
  </a>
</span>
            `
          );
          p.innerHTML = updated;
          break; // only replace first occurrence per term
        }
      }
    }

    // Attach hover/focus events to fetch partial HTML on demand
    document.querySelectorAll('.glossary-term').forEach(termEl => {
      const slug = termEl.dataset.slug;
      const tooltip = termEl.querySelector('.glossary-tooltip');
      let loaded = false;

      async function loadTooltip() {
        if (loaded) return;
        try {
          const res = await fetch(`/glossary/${slug}/partial/index.html`);
          if (!res.ok) throw new Error(`Failed to load tooltip for ${slug}`);
          tooltip.innerHTML = await res.text();
          loaded = true;
        } catch (err) {
          tooltip.innerHTML = `<em>Failed to load content</em>`;
        }
      }

      // Show tooltip on hover/focus
      termEl.addEventListener('mouseenter', async () => {
        await loadTooltip();
        tooltip.classList.remove('hidden');
      });
      termEl.addEventListener('focus', async () => {
        await loadTooltip();
        tooltip.classList.remove('hidden');
      });

      // Hide tooltip on mouseleave/blur
      termEl.addEventListener('mouseleave', () => tooltip.classList.add('hidden'));
      termEl.addEventListener('blur', () => tooltip.classList.add('hidden'));
    });
  }

  document.addEventListener('DOMContentLoaded', enhanceGlossaryTerms);
</script>

